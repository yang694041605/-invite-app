<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¦å½©3Dæ™ºèƒ½æ¨ç†ç³»ç»Ÿ - æˆæƒç™»å½•</title>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .auth-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 450px;
            position: relative;
            overflow: hidden;
        }
        .auth-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }
        .logo {
            text-align: center;
            margin-bottom: 30px;
        }
        .logo h1 {
            color: #333;
            font-size: 32px;
            margin-bottom: 8px;
            font-weight: 700;
        }
        .logo p {
            color: #666;
            font-size: 16px;
            opacity: 0.8;
        }
        .input-group {
            margin-bottom: 25px;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
            font-size: 14px;
        }
        .auth-input {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 18px;
            transition: all 0.3s ease;
            letter-spacing: 2px;
            text-transform: uppercase;
            text-align: center;
        }
        .auth-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .auth-input::placeholder {
            color: #ccc;
            letter-spacing: normal;
            text-transform: none;
        }
        .auth-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        .auth-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        .auth-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .message {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
            display: none;
        }
        .success { 
            background: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb;
            display: block;
        }
        .error { 
            background: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb;
            display: block;
        }
        .info { 
            background: #cce7ff; 
            color: #004085; 
            border: 1px solid #99d3ff;
            display: block;
        }
        .status-info {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-top: 25px;
            border: 1px solid #e9ecef;
        }
        .status-info h3 {
            text-align: center;
            margin-bottom: 20px;
            color: #495057;
            font-size: 18px;
        }
        .status-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }
        .status-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        .status-label {
            color: #6c757d;
            font-weight: 500;
        }
        .status-value {
            color: #495057;
            font-weight: 600;
        }
        .countdown {
            color: #dc3545;
            font-weight: 700;
        }
        .footer {
            text-align: center;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
            color: #6c757d;
            font-size: 13px;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .hidden {
            display: none;
        }
        .visible {
            display: block;
        }
        
        /* æ¬¢è¿åŠ¨ç”»ç•Œé¢æ ·å¼ */
        .welcome-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a56db 0%, #1e40af 25%, #7c3aed 50%, #db2777 75%, #f43f5e 100%);
            background-size: 400% 400%;
            animation: gradientAnimation 8s ease infinite;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 1s ease-out;
        }
        
        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .welcome-content {
            text-align: center;
            color: white;
            opacity: 0;
            animation: fadeIn 2s ease forwards;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .welcome-title {
            font-size: 48px;
            font-weight: 800;
            margin-bottom: 20px;
            text-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            letter-spacing: 2px;
            animation: titleAnimation 3s ease forwards;
            animation-delay: 0.5s;
        }
        
        @keyframes titleAnimation {
            from { opacity: 0; transform: scale(0.8) translateY(50px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        
        .welcome-subtitle {
            font-size: 24px;
            font-weight: 400;
            margin-bottom: 40px;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            animation: subtitleAnimation 3s ease forwards;
            animation-delay: 1s;
        }
        
        @keyframes subtitleAnimation {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .welcome-loader {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1.5s linear infinite;
            margin: 0 auto;
            animation: loaderAnimation 2s ease forwards;
            animation-delay: 1.5s;
        }
        
        @keyframes loaderAnimation {
            from { opacity: 0; transform: scale(0.5); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body>
    <!-- åŠ¨ç”»æ¬¢è¿ç•Œé¢ -->
    <div id="welcome-animation" class="welcome-animation">
        <div class="welcome-content">
            <h1 class="welcome-title">æ¬¢è¿èµ°è¿›ç¦å½©3Dä¸–ç•Œ</h1>
            <p class="welcome-subtitle">å…±åŒæ¢ç©¶æœªçŸ¥æ•°å­—é­…åŠ›</p>
            <div class="welcome-loader"></div>
        </div>
    </div>
    
    <div class="auth-container" style="display: none;">
        <div class="logo">
            <h1>ğŸ² ç¦å½©3Dæ™ºèƒ½æ¨ç†ç³»ç»Ÿ</h1>
            <p>å®‰å…¨æˆæƒéªŒè¯</p>
        </div>
        
        <!-- æˆæƒè¡¨å• -->
        <div id="auth-form">
            <div class="input-group">
                <label for="customerName">å®¢æˆ·å§“å</label>
                <input 
                    type="text" 
                    id="customerName" 
                    class="auth-input" 
                    placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å"
                    autocomplete="name"
                >
            </div>
            <div class="input-group">
                <label for="customerPhone">è”ç³»ç”µè¯</label>
                <input 
                    type="tel" 
                    id="customerPhone" 
                    class="auth-input" 
                    placeholder="è¯·è¾“å…¥æ‚¨çš„æ‰‹æœºå·ç "
                    autocomplete="tel"
                    maxlength="11"
                >
            </div>
            <div class="input-group">
                <label for="authCode">è¯·è¾“å…¥6ä½æˆæƒç </label>
                <input 
                    type="text" 
                    id="authCode" 
                    class="auth-input" 
                    placeholder="ä¾‹å¦‚: ABC123"
                    maxlength="6"
                    autocomplete="off"
                >
            </div>
            <button id="authBtn" class="auth-btn">
                <span id="btnText">æˆæƒç™»å½•</span>
            </button>
            
            
            
            <div id="authMessage" class="message"></div>
        </div>
        
        <!-- æˆæƒçŠ¶æ€æ˜¾ç¤º -->
        <div id="auth-status" class="hidden">
            <div class="status-info">
                <h3>âœ… æˆæƒä¿¡æ¯</h3>
                <div class="status-row">
                    <span class="status-label">ç”¨æˆ·ID:</span>
                    <span class="status-value" id="userId"></span>
                </div>
                <div class="status-row">
                    <span class="status-label">æœ‰æ•ˆæœŸè‡³:</span>
                    <span class="status-value" id="expireTime"></span>
                </div>
                <div class="status-row">
                    <span class="status-label">å‰©ä½™æ—¶é—´:</span>
                    <span class="status-value">
                        <span id="remainDays"></span>å¤© 
                        <span id="remainHours"></span>å°æ—¶
                    </span>
                </div>
                <div class="status-row">
                    <span class="status-label">æˆæƒå¤©æ•°:</span>
                    <span class="status-value" id="expireDays"></span>
                </div>
                <div class="status-row">
                    <span class="status-label">ä½¿ç”¨æ¬¡æ•°:</span>
                    <span class="status-value">
                        <span id="usageCount"></span>/<span id="maxUsageLimit"></span>
                    </span>
                </div>
            </div>
            
            <button id="enterApp" class="auth-btn">ğŸ¯ è¿›å…¥ç¦å½©3Dæ™ºèƒ½æ¨ç†ç³»ç»Ÿ</button>
            <button id="logoutBtn" class="auth-btn" style="background: linear-gradient(135deg, #dc3545, #c82333); margin-top: 10px;">ğŸšª é€€å‡ºç™»å½•</button>
        </div>
        
        <div class="footer">
            <p>ğŸ” éœ€è¦æˆæƒç ï¼Ÿè¯·è”ç³»ç³»ç»Ÿç®¡ç†å‘˜</p>
            <p style="margin-top: 5px; font-size: 12px; opacity: 0.7;">
                ç³»ç»Ÿç‰ˆæœ¬: v2.0 | å®‰å…¨æˆæƒç³»ç»Ÿ
            </p>
        </div>
    </div>

    <!-- PWAæ”¯æŒ -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ç¦å½©3D">
    
    <!-- è…¾è®¯äº‘å¼€å‘SDK -->
    <script src="https://imgcache.qq.com/qcloud/tcbjs/1.10.0/tcb.js"></script>
    
    <!-- Service Workeræ³¨å†Œ -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(function(err) {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>
    
    <script>
        // ===========================================
        // é…ç½®åŒºåŸŸ - è¯·æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹
        // ===========================================
        const CONFIG = {
            ENV_ID: 'my-app-fucai-4gcaw7hv5d0274cb', // è…¾è®¯äº‘ç¯å¢ƒID
            DEFAULT_PAGE: 'index.html',
            DEBUG_MODE: false // è°ƒè¯•æ¨¡å¼ï¼štrueè¡¨ç¤ºä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼Œfalseè¡¨ç¤ºè°ƒç”¨çœŸå®äº‘å‡½æ•°
        };

        // ===========================================
        // å…¨å±€å˜é‡
        // ===========================================
        let app = null;
        let currentAuthData = null;

        // ===========================================
        // DOM å…ƒç´ 
        // ===========================================
        const elements = {
            customerNameInput: document.getElementById('customerName'),
            customerPhoneInput: document.getElementById('customerPhone'),
            authCodeInput: document.getElementById('authCode'),
            authBtn: document.getElementById('authBtn'),
            btnText: document.getElementById('btnText'),
            authMessage: document.getElementById('authMessage'),
            authForm: document.getElementById('auth-form'),
            authStatus: document.getElementById('auth-status'),
            userId: document.getElementById('userId'),
            expireTime: document.getElementById('expireTime'),
            remainDays: document.getElementById('remainDays'),
            remainHours: document.getElementById('remainHours'),
            expireDays: document.getElementById('expireDays'),
            usageCount: document.getElementById('usageCount'),
            maxUsageLimit: document.getElementById('maxUsageLimit'),
            enterApp: document.getElementById('enterApp'),
            logoutBtn: document.getElementById('logoutBtn')
        };

        // ===========================================
        // åˆå§‹åŒ–åº”ç”¨
        // ===========================================
        async function initApp() {
            try {
                // åˆå§‹åŒ–è…¾è®¯äº‘å¼€å‘
                app = tcb.init({
                    env: CONFIG.ENV_ID
                });
                
                console.log('âœ… è…¾è®¯äº‘å¼€å‘åˆå§‹åŒ–æˆåŠŸ');
                
                // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
                bindEvents();
                
                // æ£€æŸ¥æœ¬åœ°ç™»å½•çŠ¶æ€
                await checkLoginStatus();
                
            } catch (error) {
                console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', error);
                showMessage('ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
            }
        }

        // ===========================================
        // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
        // ===========================================
        function bindEvents() {
            // æˆæƒæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            elements.authBtn.addEventListener('click', verifyAuth);
            
            // å›è½¦é”®æäº¤
            elements.authCodeInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    verifyAuth();
                }
            });
            
            // è¾“å…¥æ ¼å¼åŒ–ï¼ˆè‡ªåŠ¨è½¬ä¸ºå¤§å†™ï¼Œåªå…è®¸å­—æ¯æ•°å­—ï¼‰
            elements.authCodeInput.addEventListener('input', function(e) {
                let value = e.target.value.toUpperCase();
                value = value.replace(/[^A-Z0-9]/g, '');
                if (value.length > 6) {
                    value = value.substring(0, 6);
                }
                e.target.value = value;
            });
            
            // è¿›å…¥åº”ç”¨æŒ‰é’®
            elements.enterApp.addEventListener('click', enterApp);
            
            // é€€å‡ºç™»å½•æŒ‰é’®
            elements.logoutBtn.addEventListener('click', logout);
        }

        // ===========================================
        // éªŒè¯æˆæƒç 
        // ===========================================
        async function verifyAuth() {
            const customerName = elements.customerNameInput.value.trim();
            const customerPhone = elements.customerPhoneInput.value.trim();
            const authCode = elements.authCodeInput.value.trim();
            
            // è¾“å…¥éªŒè¯
            if (!customerName) {
                showMessage('è¯·è¾“å…¥å®¢æˆ·å§“å', 'error');
                elements.customerNameInput.focus();
                return;
            }
            
            if (!customerPhone) {
                showMessage('è¯·è¾“å…¥è”ç³»ç”µè¯', 'error');
                elements.customerPhoneInput.focus();
                return;
            }
            
            if (!/^1[3-9]\d{9}$/.test(customerPhone)) {
                showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„æ‰‹æœºå·ç ', 'error');
                elements.customerPhoneInput.focus();
                return;
            }
            
            if (!authCode) {
                showMessage('è¯·è¾“å…¥æˆæƒç ', 'error');
                elements.authCodeInput.focus();
                return;
            }
            
            if (authCode.length !== 6) {
                showMessage('æˆæƒç å¿…é¡»æ˜¯6ä½å­—ç¬¦', 'error');
                elements.authCodeInput.focus();
                return;
            }
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            setButtonLoading(true);
            hideMessage();
            
            try {
                // è·å–è®¾å¤‡ä¿¡æ¯
                const deviceInfo = {
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    screen: `${screen.width}Ã—${screen.height}`,
                    language: navigator.language,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    timestamp: new Date().toISOString(),
                    referrer: document.referrer
                };
                
                console.log('ğŸ” æ­£åœ¨éªŒè¯æˆæƒç :', authCode);
                
                let result;
                let isLocalVerification = false;
                
                // è°ƒè¯•æ¨¡å¼ï¼šä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                if (CONFIG.DEBUG_MODE) {
                    console.log('ğŸ”§ è°ƒè¯•æ¨¡å¼ï¼šä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®');
                    // æ¨¡æ‹Ÿäº‘å‡½æ•°è¿”å›ç»“æœ
                    result = {
                        result: {
                            success: true,
                            userId: `user_${Date.now()}`,
                            expireTime: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(),
                            remainDays: 30,
                            totalRemainMinutes: 30 * 24 * 60,
                            expireDays: 30,
                            usageCount: 1,
                            maxUsageLimit: 1
                        }
                    };
                } else {
                    try {
                        // è°ƒç”¨çœŸå®äº‘å‡½æ•°
                        result = await app.callFunction({
                            name: 'verifyAuthCode',
                            data: {
                                authCode: authCode,
                                customerName: customerName,
                                customerPhone: customerPhone,
                                deviceInfo: deviceInfo,
                                userInfo: {
                                        loginPage: 'login.html',
                                        appVersion: '2.0',
                                        customerName: customerName,
                                        customerPhone: customerPhone
                                    }
                            }
                        });
                    } catch (cloudError) {
                        console.error('ğŸ’¥ äº‘å‡½æ•°è°ƒç”¨å¤±è´¥ï¼Œå°è¯•æœ¬åœ°éªŒè¯:', cloudError);
                        // äº‘å‡½æ•°è°ƒç”¨å¤±è´¥ï¼Œå°è¯•æœ¬åœ°éªŒè¯
                        isLocalVerification = true;
                        result = await localVerifyAuthCode(authCode, customerName, customerPhone);
                    }
                }
                
                console.log('ğŸ“‹ éªŒè¯ç»“æœ:', result);
                
                // ä¸¥æ ¼éªŒè¯ï¼šåªæœ‰åœ¨äº‘å‡½æ•°è°ƒç”¨æˆåŠŸæˆ–æœ¬åœ°éªŒè¯æ‰¾åˆ°åŒ¹é…å®¢æˆ·æ—¶æ‰å…è®¸ç™»å½•
                if (result.result.success) {
                    // æˆæƒæˆåŠŸ
                    console.log('âœ… æˆæƒéªŒè¯æˆåŠŸ');
                    currentAuthData = result.result;
                    
                    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                    localStorage.setItem('userId', result.result.userId);
                    localStorage.setItem('authData', JSON.stringify(result.result));
                    
                    showMessage('æˆæƒæˆåŠŸï¼æ­£åœ¨è·³è½¬...', 'success');
                    
                    // æ˜¾ç¤ºæˆæƒçŠ¶æ€
                    setTimeout(() => {
                        showAuthStatus(result.result);
                    }, 1000);
                    
                } else {
                    // æˆæƒå¤±è´¥
                    console.log('âŒ æˆæƒéªŒè¯å¤±è´¥:', result.result.message);
                    showMessage(result.result.message || 'æˆæƒç æ— æ•ˆæˆ–å·²è¿‡æœŸ', 'error');
                    setButtonLoading(false);
                }
                
            } catch (error) {
                console.error('ğŸ’¥ æˆæƒéªŒè¯å¼‚å¸¸:', error);
                // ç½‘ç»œé”™è¯¯æ—¶ï¼Œå¼ºåˆ¶å°è¯•æœ¬åœ°éªŒè¯
                console.log('ğŸ”„ ç½‘ç»œé”™è¯¯ï¼Œå¼ºåˆ¶å°è¯•æœ¬åœ°éªŒè¯');
                try {
                    const localResult = await localVerifyAuthCode(authCode, customerName, customerPhone);
                    if (localResult.result.success) {
                        // æœ¬åœ°éªŒè¯æˆåŠŸ
                        console.log('âœ… æœ¬åœ°éªŒè¯æˆåŠŸ');
                        currentAuthData = localResult.result;
                        
                        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                        localStorage.setItem('userId', localResult.result.userId);
                        localStorage.setItem('authData', JSON.stringify(localResult.result));
                        
                        showMessage('æˆæƒæˆåŠŸï¼æ­£åœ¨è·³è½¬...', 'success');
                        
                        // æ˜¾ç¤ºæˆæƒçŠ¶æ€
                        setTimeout(() => {
                            showAuthStatus(localResult.result);
                        }, 1000);
                    } else {
                        // æœ¬åœ°éªŒè¯ä¹Ÿå¤±è´¥
                        showMessage('æˆæƒç æ— æ•ˆæˆ–å·²è¿‡æœŸ', 'error');
                        setButtonLoading(false);
                    }
                } catch (localError) {
                    // æœ¬åœ°éªŒè¯ä¹Ÿå‡ºé”™
                    console.error('ğŸ’¥ æœ¬åœ°éªŒè¯å¼‚å¸¸:', localError);
                    showMessage('æˆæƒç æ— æ•ˆæˆ–å·²è¿‡æœŸ', 'error');
                    setButtonLoading(false);
                }
            }
        }
        
        // æœ¬åœ°éªŒè¯æˆæƒç 
        async function localVerifyAuthCode(authCode, customerName, customerPhone) {
            console.log('ğŸ” æ­£åœ¨æœ¬åœ°éªŒè¯æˆæƒç :', authCode);
            
            // ä»æœ¬åœ°å­˜å‚¨è·å–å¾…éªŒè¯å®¢æˆ·å’Œæˆæƒå®¢æˆ·
            const pendingClients = JSON.parse(localStorage.getItem('pendingClients') || '[]');
            const authorizedClients = JSON.parse(localStorage.getItem('authorizedClients') || '[]');
            
            // æ£€æŸ¥å¾…éªŒè¯å®¢æˆ·
            const pendingClient = pendingClients.find(client => 
                client.verifyCode === authCode && 
                client.name === customerName && 
                client.phone === customerPhone
            );
            
            if (pendingClient) {
                console.log('âœ… æœ¬åœ°éªŒè¯æˆåŠŸï¼šæ‰¾åˆ°å¾…éªŒè¯å®¢æˆ·');
                
                // è®¡ç®—å‰©ä½™æ—¶é—´
                const now = new Date();
                const expireDate = new Date(pendingClient.expireTime);
                const diffTime = expireDate - now;
                const remainDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const totalRemainMinutes = Math.ceil(diffTime / (1000 * 60));
                
                if (remainDays <= 0) {
                    return {
                        result: {
                            success: false,
                            message: 'æˆæƒç å·²è¿‡æœŸ'
                        }
                    };
                }
                
                // å°†å®¢æˆ·ä»å¾…éªŒè¯åˆ—è¡¨ç§»åŠ¨åˆ°æˆæƒåˆ—è¡¨
                const updatedPendingClients = pendingClients.filter(client => client.id !== pendingClient.id);
                localStorage.setItem('pendingClients', JSON.stringify(updatedPendingClients));
                
                // æ›´æ–°å®¢æˆ·çŠ¶æ€ä¸ºæˆæƒ
                const authorizedClient = {
                    ...pendingClient,
                    id: `user_${Date.now()}`,
                    status: 'active',
                    activationTime: now.toISOString(),
                    usageCount: 1,
                    maxUsageLimit: 1
                };
                authorizedClients.push(authorizedClient);
                localStorage.setItem('authorizedClients', JSON.stringify(authorizedClients));
                
                return {
                    result: {
                        success: true,
                        userId: authorizedClient.id,
                        expireTime: authorizedClient.expireTime,
                        remainDays: remainDays,
                        totalRemainMinutes: totalRemainMinutes,
                        expireDays: pendingClient.expireDays,
                        usageCount: 1,
                        maxUsageLimit: 1
                    }
                };
            }
            
            // æ£€æŸ¥æˆæƒå®¢æˆ·
            const authorizedClient = authorizedClients.find(client => 
                client.verifyCode === authCode && 
                client.name === customerName && 
                client.phone === customerPhone
            );
            
            if (authorizedClient) {
                console.log('âœ… æœ¬åœ°éªŒè¯æˆåŠŸï¼šæ‰¾åˆ°æˆæƒå®¢æˆ·');
                
                // è®¡ç®—å‰©ä½™æ—¶é—´
                const now = new Date();
                const expireDate = new Date(authorizedClient.expireTime);
                const diffTime = expireDate - now;
                const remainDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const totalRemainMinutes = Math.ceil(diffTime / (1000 * 60));
                
                if (remainDays <= 0) {
                    return {
                        result: {
                            success: false,
                            message: 'æˆæƒå·²è¿‡æœŸ'
                        }
                    };
                }
                
                // æ›´æ–°ä½¿ç”¨æ¬¡æ•°
                authorizedClient.usageCount = (authorizedClient.usageCount || 0) + 1;
                localStorage.setItem('authorizedClients', JSON.stringify(authorizedClients));
                
                return {
                    result: {
                        success: true,
                        userId: authorizedClient.id,
                        expireTime: authorizedClient.expireTime,
                        remainDays: remainDays,
                        totalRemainMinutes: totalRemainMinutes,
                        expireDays: authorizedClient.expireDays,
                        usageCount: authorizedClient.usageCount,
                        maxUsageLimit: authorizedClient.maxUsageLimit || 1
                    }
                };
            }
            
            // æœªæ‰¾åˆ°åŒ¹é…çš„å®¢æˆ·
            console.log('âŒ æœ¬åœ°éªŒè¯å¤±è´¥ï¼šæœªæ‰¾åˆ°åŒ¹é…çš„å®¢æˆ·');
            return {
                result: {
                    success: false,
                    message: 'æˆæƒç æ— æ•ˆæˆ–å·²è¿‡æœŸ'
                }
            };
        }

        // ===========================================
        // æ£€æŸ¥ç™»å½•çŠ¶æ€ - æ¯æ¬¡ç™»å½•éƒ½éœ€è¦é‡æ–°éªŒè¯
        // ===========================================
        async function checkLoginStatus() {
            // æ¸…é™¤æœ¬åœ°å­˜å‚¨çš„ç™»å½•ä¿¡æ¯ï¼Œç¡®ä¿æ¯æ¬¡ç™»å½•éƒ½éœ€è¦é‡æ–°éªŒè¯
            clearAuthData();
            console.log('ğŸ”„ æ¸…é™¤æœ¬åœ°ç™»å½•ä¿¡æ¯ï¼Œéœ€è¦é‡æ–°éªŒè¯');
        }

        // ===========================================
        // æ˜¾ç¤ºæˆæƒçŠ¶æ€
        // ===========================================
        function showAuthStatus(authInfo) {
            // éšè—ç™»å½•è¡¨å•ï¼Œæ˜¾ç¤ºçŠ¶æ€é¡µé¢
            elements.authForm.classList.add('hidden');
            elements.authStatus.classList.remove('hidden');
            
            // å¡«å……æˆæƒä¿¡æ¯
            elements.userId.textContent = authInfo.userId || 'æœªçŸ¥';
            elements.expireTime.textContent = formatDateTime(authInfo.expireTime);
            elements.remainDays.textContent = authInfo.remainDays || 0;
            elements.remainHours.textContent = Math.floor((authInfo.totalRemainMinutes || 0) / 60) % 24;
            elements.expireDays.textContent = authInfo.expireDays || 0;
            elements.usageCount.textContent = authInfo.usageCount || 1;
            elements.maxUsageLimit.textContent = authInfo.maxUsageLimit || 1;
            
            // å¦‚æœå³å°†åˆ°æœŸï¼Œæ˜¾ç¤ºè­¦å‘Šé¢œè‰²
            if ((authInfo.remainDays || 0) <= 3) {
                elements.remainDays.parentElement.querySelector('.status-value').style.color = '#dc3545';
                elements.remainDays.parentElement.querySelector('.status-value').style.fontWeight = 'bold';
            }
        }

        // ===========================================
        // è¿›å…¥ä¸»åº”ç”¨
        // ===========================================
        function enterApp() {
            console.log('ğŸš€ è¿›å…¥ä¸»åº”ç”¨');
            // è·³è½¬åˆ°ä¸»é¡µé¢
            window.location.href = CONFIG.DEFAULT_PAGE;
        }

        // ===========================================
        // é€€å‡ºç™»å½•
        // ===========================================
        function logout() {
            console.log('ğŸ‘‹ ç”¨æˆ·é€€å‡ºç™»å½•');
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                clearAuthData();
                location.reload();
            }
        }

        // ===========================================
        // æ¸…é™¤æˆæƒæ•°æ®
        // ===========================================
        function clearAuthData() {
            localStorage.removeItem('userId');
            localStorage.removeItem('authData');
            localStorage.removeItem('adminLoggedIn');
            localStorage.removeItem('adminLoginTime');
            currentAuthData = null;
            
            // é‡ç½®UI
            elements.authForm.classList.remove('hidden');
            elements.authStatus.classList.add('hidden');
            elements.customerNameInput.value = '';
            elements.customerPhoneInput.value = '';
            elements.authCodeInput.value = '';
            setButtonLoading(false);
            hideMessage();
            
            console.log('ğŸ§¹ æˆæƒæ•°æ®å·²æ¸…é™¤');
        }
        
        // ===========================================
        // å¤„ç†æ·»åŠ åˆ°æ¡Œé¢äº‹ä»¶
        // ===========================================
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            // é˜»æ­¢Chrome 67åŠæ›´æ—©ç‰ˆæœ¬è‡ªåŠ¨æ˜¾ç¤ºå®‰è£…æç¤º
            e.preventDefault();
            // å­˜å‚¨äº‹ä»¶ï¼Œä»¥ä¾¿ç¨åè§¦å‘
            deferredPrompt = e;
            console.log('âœ… å¯ä»¥æ·»åŠ åˆ°æ¡Œé¢äº†');
            
            // å¯ä»¥åœ¨è¿™é‡Œæ˜¾ç¤ºè‡ªå®šä¹‰çš„"æ·»åŠ åˆ°æ¡Œé¢"æŒ‰é’®
            // ä¾‹å¦‚ï¼šdocument.getElementById('add-to-home-screen').style.display = 'block';
        });
        
        // æ‰‹åŠ¨è§¦å‘æ·»åŠ åˆ°æ¡Œé¢
        function addToHomeScreen() {
            if (deferredPrompt) {
                // æ˜¾ç¤ºå®‰è£…æç¤º
                deferredPrompt.prompt();
                
                // ç­‰å¾…ç”¨æˆ·å“åº”
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('âœ… ç”¨æˆ·å·²æ·»åŠ åˆ°æ¡Œé¢');
                    } else {
                        console.log('âŒ ç”¨æˆ·æ‹’ç»æ·»åŠ åˆ°æ¡Œé¢');
                    }
                    // æ¸…é™¤ä¿å­˜çš„äº‹ä»¶ï¼Œå› ä¸ºå®ƒåªèƒ½ä½¿ç”¨ä¸€æ¬¡
                    deferredPrompt = null;
                });
            }
        }

        // ===========================================
        // å·¥å…·å‡½æ•°
        // ===========================================

        // è®¾ç½®æŒ‰é’®åŠ è½½çŠ¶æ€
        function setButtonLoading(loading) {
            if (loading) {
                elements.btnText.innerHTML = '<span class="loading"></span>éªŒè¯ä¸­...';
                elements.authBtn.disabled = true;
            } else {
                elements.btnText.textContent = 'æˆæƒç™»å½•';
                elements.authBtn.disabled = false;
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(text, type = 'info') {
            elements.authMessage.textContent = text;
            elements.authMessage.className = `message ${type}`;
            elements.authMessage.style.display = 'block';
        }

        // éšè—æ¶ˆæ¯
        function hideMessage() {
            elements.authMessage.style.display = 'none';
        }

        // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
        function formatDateTime(timestamp) {
            if (!timestamp) return 'æœªçŸ¥';
            const date = new Date(timestamp);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // ===========================================
        // åŠ¨ç”»æ¬¢è¿ç•Œé¢å¤„ç†
        // ===========================================
        function handleWelcomeAnimation() {
            // 5ç§’åéšè—åŠ¨ç”»ç•Œé¢ï¼Œæ˜¾ç¤ºç™»å½•ç•Œé¢
            setTimeout(function() {
                const welcomeAnimation = document.getElementById('welcome-animation');
                const authContainer = document.querySelector('.auth-container');
                
                // æ·»åŠ æ·¡å‡ºåŠ¨ç”»
                welcomeAnimation.style.opacity = '0';
                
                // ç­‰å¾…åŠ¨ç”»ç»“æŸåéšè—
                setTimeout(function() {
                    welcomeAnimation.style.display = 'none';
                    authContainer.style.display = 'block';
                }, 1000);
            }, 5000);
        }
        
        // ===========================================
        // å¯åŠ¨åº”ç”¨
        // ===========================================
        document.addEventListener('DOMContentLoaded', function() {
            handleWelcomeAnimation();
            initApp();
        });
        
        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', function() {
            console.log('ğŸ‘‹ é¡µé¢å³å°†å¸è½½');
        });
    </script>
</body>
</html>